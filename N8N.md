# H∆∞·ªõng d·∫´n ki·ªÉm tra c√°c h·ªá th·ªëng b·∫±ng n8n
### Workflow
```
{ "name": "Check System", "nodes": [ { "parameters": { "command": "free | awk '/Mem:/ {printf \"%.2f\", (1 - $7/$2) * 100}'" }, "id": "c0d1b90b-6803-4f6d-a808-11b542604ac3", "name": "Check RAM usage", "type": "n8n-nodes-base.ssh", "position": [ -400, -240 ], "executeOnce": false, "typeVersion": 1, "credentials": { "sshPassword": { "id": "MEEc25RNo6SKcMdk", "name": "SSH 14.225.255.126" } } }, { "parameters": { "command": "df -h | awk '$NF==\"/\"{printf \"%.2f\", $5}'" }, "id": "6bfa0a1e-da66-48c1-8698-efe3d5c068a0", "name": "Check Disk usage", "type": "n8n-nodes-base.ssh", "position": [ -180, -240 ], "executeOnce": false, "typeVersion": 1, "credentials": { "sshPassword": { "id": "MEEc25RNo6SKcMdk", "name": "SSH 14.225.255.126" } } }, { "parameters": { "command": "#!/bin/bash\nCHECK_ONE=$(top -bn 1 | grep \"Cpu(s)\" | sed \"s/.*, *\\([0-9.]*\\)%* id.*/\\1/\" | awk '{print 100 - $1}')\n#echo $CHECK_ONE\nsleep 70s\nCHECK_TWO=$(top -bn 1 | grep \"Cpu(s)\" | sed \"s/.*, *\\([0-9.]*\\)%* id.*/\\1/\" | awk '{print 100 - $1}')\n#echo $CHECK_TWO\nsleep 70s\nCHECK_THREE=$(top -bn 1 | grep \"Cpu(s)\" | sed \"s/.*, *\\([0-9.]*\\)%* id.*/\\1/\" | awk '{print 100 - $1}')\n#echo $CHECK_THREE\nsleep 70s\nCHECK_FOUR=$(top -bn 1 | grep \"Cpu(s)\" | sed \"s/.*, *\\([0-9.]*\\)%* id.*/\\1/\" | awk '{print 100 - $1}')\n#echo $CHECK_FOUR\nsleep 70s\nCHECK_FIVE=$(top -bn 1 | grep \"Cpu(s)\" | sed \"s/.*, *\\([0-9.]*\\)%* id.*/\\1/\" | awk '{print 100 - $1}')\n#echo $CHECK_FIVE\nif (( $(echo \"$CHECK_ONE > 90\" | bc -l) )) && \\\n   (( $(echo \"$CHECK_TWO > 90\" | bc -l) )) && \\\n   (( $(echo \"$CHECK_THREE > 90\" | bc -l) )) && \\\n   (( $(echo \"$CHECK_FOUR > 90\" | bc -l) )) && \\\n   (( $(echo \"$CHECK_FIVE > 90\" | bc -l) )); then\n\n    echo $CHECK_FIVE\nelse\n    echo 0\nfi\n\n\n" }, "id": "817771fc-d28f-4abd-b9d7-8ec228e4f7ed", "name": "Check CPU usage", "type": "n8n-nodes-base.ssh", "position": [ -840, -240 ], "executeOnce": false, "typeVersion": 1, "credentials": { "sshPassword": { "id": "MEEc25RNo6SKcMdk", "name": "SSH 14.225.255.126" } } }, { "parameters": { "command": "#!/bin/bash\n\ncheck_nginx=$(systemctl is-active nginx | awk \"{print $1}\")\necho $check_nginx\ncheck_mysql=$(systemctl is-active mysql | awk \"{print $1}\")\necho $check_mysql\ncheck_php_fpm=$(systemctl is-active php8.1-fpm | awk \"{print $1}\")\necho $check_php_fpm\n" }, "id": "25e36b7a-4f6d-40e1-852f-de9207d5dfba", "name": "Check Service", "type": "n8n-nodes-base.ssh", "position": [ 240, -240 ], "executeOnce": false, "typeVersion": 1, "credentials": { "sshPassword": { "id": "MEEc25RNo6SKcMdk", "name": "SSH 14.225.255.126" } } }, { "parameters": { "command": "df -ih | awk '$NF==\"/\"{printf \"%.2f\", $5}'" }, "type": "n8n-nodes-base.ssh", "typeVersion": 1, "position": [ -640, -240 ], "id": "777ddd34-cd9a-41ae-a85e-c1600ebdd84e", "name": "Check inode Usage", "credentials": { "sshPassword": { "id": "MEEc25RNo6SKcMdk", "name": "SSH 14.225.255.126" } } }, { "parameters": { "command": "#!/bin/bash\n\n# L·∫•y s·ªë core CPU\ncores=$(nproc)\n\n# L·∫•y load average 1 ph√∫t\nload1=$(awk '{print $2}' /proc/loadavg)\n\n# So s√°nh\nthreshold=$(echo \"$cores * 1.0\" | bc)  # cho ph√©p 100% CPU load\n\n# In th√¥ng b√°o\nif (( $(echo \"$load1 > $threshold\" | bc -l) )); then\n    echo $load1\nelse\n    echo 0\nfi\n" }, "id": "c6b6558d-5cf6-4989-8ccc-0bee2e40c79e", "name": "Check Average", "type": "n8n-nodes-base.ssh", "position": [ 20, -240 ], "executeOnce": false, "typeVersion": 1, "credentials": { "sshPassword": { "id": "MEEc25RNo6SKcMdk", "name": "SSH 14.225.255.126" } } }, { "parameters": { "rule": { "interval": [ { "field": "minutes" } ] } }, "id": "3ee87af8-f164-4e60-9d42-eb65a53ce0f3", "name": "Trigger Check System", "type": "n8n-nodes-base.scheduleTrigger", "position": [ -1080, -240 ], "typeVersion": 1.2 }, { "parameters": { "assignments": { "assignments": [ { "id": "49cf7bfb-eb70-454c-811b-6a6f9ecb462b", "name": "Nginx Status ", "value": "={{ $json.ServiceStatus.split('\\n')[0].trim() }}", "type": "string" }, { "id": "4a388c36-5a41-48ef-b998-38734827f56e", "name": "MySQL Status", "value": "={{ $json.ServiceStatus.split('\\n')[1].trim() }}", "type": "string" }, { "id": "d6d59af7-157a-481a-ace3-5361b17f390f", "name": "PHP_FPM", "value": "={{ $json.ServiceStatus.split('\\n')[2].trim() }}", "type": "string" }, { "id": "392ff3e0-b7b6-48dd-b759-49701b895a4e", "name": "CPU Status", "value": "={{ $json.CPU }}", "type": "string" }, { "id": "3a928756-860c-4e77-971b-75abee91d933", "name": "Disk Status", "value": "={{ $json.Disk }}", "type": "string" }, { "id": "93485443-3858-4868-a032-b9dc1a4be319", "name": "Average", "value": "={{ $('Check Average').item.json.stdout }}", "type": "string" }, { "id": "96e03619-fa91-4025-9628-63a3be3c19c7", "name": "Inode", "value": "={{ $json.Inode }}", "type": "string" }, { "id": "693bb184-804f-4ffe-8337-cc66ccac1e51", "name": "RAM", "value": "={{ $json.RAM }}", "type": "string" } ] }, "options": {} }, "type": "n8n-nodes-base.set", "typeVersion": 3.4, "position": [ -500, 80 ], "id": "cd6b41c9-6a0b-44ca-8100-55547646ab52", "name": "Edit Result Check Service" }, { "parameters": { "mode": "combineBySql", "numberInputs": 6, "query": "SELECT\n  input1.stdout AS CPU,\n  input2.stdout AS Disk,\n  input3.stdout AS RAM,\n  input4.stdout AS LoadAverage,\n  input5.stdout AS Inode,\n  input6.stdout AS ServiceStatus\nFROM input1\nLEFT JOIN input2 ON true\nLEFT JOIN input3 ON true\nLEFT JOIN input4 ON true\nLEFT JOIN input5 ON true\nLEFT JOIN input6 ON true" }, "id": "abfcd5b9-2502-47a3-a19d-c58d5db9d519", "name": "Merge check results", "type": "n8n-nodes-base.merge", "position": [ -780, 20 ], "typeVersion": 3 }, { "parameters": { "jsCode": "const data = $json;\n\n// 1. C√°c service c·∫ßn check \"active/inactive\"\nconst services = [\n  \"Nginx Status \",\n  \"MySQL Status\",\n  \"PHP_FPM\"\n];\n\nlet msg = '‚ö†Ô∏è *C·∫£nh b√°o:*\\n';\nlet alert = false;\n\n// üîß T√πy ch·ªânh ri√™ng t·ª´ng lo·∫°i t√†i nguy√™n\nconst diskUsage = parseFloat(data[\"Disk Status\"]);\nif (!isNaN(diskUsage)) {\n  if (diskUsage >= 90) {\n    alert = true;\n    msg += `- üî¥ Dung l∆∞·ª£ng ƒëƒ©a ƒëang r·∫•t cao: ${diskUsage} % \\n`;\n  } else if (diskUsage > 80) {\n    alert = true;\n    msg += `- üü° Dung l∆∞·ª£ng ƒëƒ©a ƒëang kh√° cao: ${diskUsage} % \\n`;\n  }\n}\n\n// üëâ T√πy ch·ªânh th√™m n·∫øu mu·ªën (v√≠ d·ª• CPU)\nconst cpuUsage = parseFloat(data[\"CPU Status\"]);\nif (!isNaN(cpuUsage) && cpuUsage >= 90) {\n  alert = true;\n  msg += `- üî¥ CPU ƒëang qu√° t·∫£i: ${cpuUsage} % \\n`;\n}\n\n// üëâ RAM\nconst ramUsage = parseFloat(data[\"RAM\"]);\nif (!isNaN(ramUsage) && ramUsage >= 90) {\n  alert = true;\n  msg += `- üî¥ RAM ƒëang qu√° t·∫£i: ${ramUsage} % \\n`;\n}\n\n// üëâ Inode\nconst inodeFree = parseFloat(data[\"Inode\"]);\nif (!isNaN(inodeFree) && inodeFree > 2) {\n  alert = true;\n  msg += `- üî¥ Inode c√≤n r·∫•t th·∫•p, hi·ªán ƒëang s·ª≠ d·ª•ng: ${inodeFree} % \\n`;\n}\n\n// üëâ Load Average\nconst loadAvg = parseFloat(data[\"Average\"]);\nif (!isNaN(loadAvg) && loadAvg > 1) {\n  alert = true;\n  msg += `- üî¥ Load Average trong 5 ph√∫t v·ª´a qua ƒëang cao: ${loadAvg} \\n`;\n}\n\n// Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•\nfor (const service of services) {\n  const status = (data[service] || \"\").toLowerCase().trim();\n  if (status === \"inactive\") {\n    alert = true;\n    msg += `- üî¥ ${service.trim()} ƒëang *inactive* ‚ùå\\n`;\n  }\n}\n\nif (!alert) {\n  return []; // Kh√¥ng c√≥ c·∫£nh b√°o ‚Üí kh√¥ng g·ª≠i ti·∫øp\n}\n\nreturn [\n  {\n    json: {\n      message: msg\n    }\n  }\n];\n" }, "type": "n8n-nodes-base.code", "typeVersion": 2, "position": [ -240, 80 ], "id": "3e9f5628-3099-458d-a71a-ec21217606ed", "name": "Code" }, { "parameters": { "authentication": "webhook", "content": "={{$json[\"message\"]}}", "options": {} }, "type": "n8n-nodes-base.discord", "typeVersion": 2, "position": [ 40, 80 ], "id": "76c0b7b6-5979-48c5-819d-cded66609a38", "name": "Alert Discord", "webhookId": "01b767d1-48f3-457e-9426-caf5892a13b2", "credentials": { "discordWebhookApi": { "id": "vYU2ovSkuEHcdKiB", "name": "Discord Webhook account" } } } ], "pinData": {}, "connections": { "Check CPU usage": { "main": [ [ { "node": "Check inode Usage", "type": "main", "index": 0 }, { "node": "Merge check results", "type": "main", "index": 0 } ] ] }, "Check RAM usage": { "main": [ [ { "node": "Merge check results", "type": "main", "index": 2 }, { "node": "Check Disk usage", "type": "main", "index": 0 } ] ] }, "Check Disk usage": { "main": [ [ { "node": "Check Average", "type": "main", "index": 0 }, { "node": "Merge check results", "type": "main", "index": 1 } ] ] }, "Check Service": { "main": [ [ { "node": "Merge check results", "type": "main", "index": 5 } ] ] }, "Check inode Usage": { "main": [ [ { "node": "Check RAM usage", "type": "main", "index": 0 }, { "node": "Merge check results", "type": "main", "index": 4 } ] ] }, "Check Average": { "main": [ [ { "node": "Check Service", "type": "main", "index": 0 }, { "node": "Merge check results", "type": "main", "index": 3 } ] ] }, "Trigger Check System": { "main": [ [ { "node": "Check CPU usage", "type": "main", "index": 0 } ] ] }, "Edit Result Check Service": { "main": [ [ { "node": "Code", "type": "main", "index": 0 } ] ] }, "Merge check results": { "main": [ [ { "node": "Edit Result Check Service", "type": "main", "index": 0 } ] ] }, "Code": { "main": [ [ { "node": "Alert Discord", "type": "main", "index": 0 } ] ] }, "Alert Discord": { "main": [ [] ] } }, "active": false, "settings": { "executionOrder": "v1" }, "versionId": "8f8a2568-9405-4a69-94e6-d7de6a136007", "meta": { "templateCredsSetupCompleted": true, "instanceId": "3ccf4ecd0404b7fa314448bdbf1ad0285178274f152b93d738dc0c826690b592" }, "id": "pFVS79o2vpqIpjR2", "tags": [] }
```
### Gi·ªõi thi·ªáu 
Workflow n√†y ƒë∆∞·ª£c x√¢y d·ª±ng nh·∫±m m·ª•c ƒë√≠ch gi√°m s√°t t√¨nh tr·∫°ng h·ªá th·ªëng m√°y ch·ªß Linux theo th·ªùi gian th·ª±c. H·ªá th·ªëng s·∫Ω ƒë·ªãnh k·ª≥ ki·ªÉm tra c√°c ch·ªâ s·ªë quan tr·ªçng nh∆∞:

- Hi·ªáu su·∫•t CPU, m·ª©c s·ª≠ d·ª•ng RAM, Disk v√† Inode

- Load Average ƒë·ªÉ ƒë√°nh gi√° m·ª©c ƒë·ªô t·∫£i h·ªá th·ªëng

Tr·∫°ng th√°i ho·∫°t ƒë·ªông c·ªßa c√°c d·ªãch v·ª• quan tr·ªçng nh∆∞:

- nginx

- php-fpm ho·∫∑c php

- mysql ho·∫∑c mariadb

Khi ph√°t hi·ªán b·∫•t k·ª≥ ch·ªâ s·ªë n√†o v∆∞·ª£t qu√° ng∆∞·ª°ng c·∫£nh b√°o, workflow s·∫Ω g·ª≠i th√¥ng b√°o t·ª©c th√¨ v·ªÅ Discord th√¥ng qua webhook, gi√∫p qu·∫£n tr·ªã vi√™n ch·ªß ƒë·ªông ph√°t hi·ªán s·ªõm v√† x·ª≠ l√Ω s·ª± c·ªë k·ªãp th·ªùi
### C√°c m·ª©c c·∫£nh b√°o nh∆∞ sau
- G·ª≠i c·∫£nh b√°o khi CPU server v∆∞·ª£t 90% trong 5 ph√∫t.
- G·ª≠i c·∫£nh b√°o khi RAM server c√≤n tr·ªëng d∆∞·ªõi 10%.
- G·ª≠i c·∫£nh b√°o khi dung l∆∞·ª£ng ·ªï c·ª©ng c√≤n tr·ªëng d∆∞·ªõi 20% (c·∫£nh b√°o) d∆∞·ªõi 10% (c·∫£nh b√°o kh·∫©n c·∫•p)
- G·ª≠i c·∫£nh b√°o  inode usage > 90%. 
- G·ª≠i c·∫£nh b√°o khi server load average tƒÉng cao b·∫•t th∆∞·ªùng.
- G·ª≠i c·∫£nh b√°o khi m·ªôt d·ªãch v·ª• quan tr·ªçng (Nginx, MySQL, PHP-FPM) b·ªã d·ª´ng.
### C√°c b∆∞·ªõc tri·ªÉn khai
1. ƒê·∫ßu ti√™n c√°c b·∫£n hay copy ƒëo·∫°n code ·ªü tr√™n sau ƒë√≥ t·∫°o workflow m·ªõi trong n8n r·ªìi paste v√†o nh√©
![image](https://github.com/user-attachments/assets/7804ce04-3ab5-4d26-bda0-626b3b09c86b)

2. T√¥i s·∫Ω gi·∫£i th√≠ch t·ª´ng node trong n√†y nh√©  
a. **Node Trigger Check System**  
·ªû node n√†y s·∫Ω l√† th·ªùi gian m√† b·∫°n ch·∫°y workflow gi√°m x√°c h·ªá th·ªëng. C√≥ th·ªÉ ch·∫°y 2 ph√∫t m·ªôt l·∫ßn, 5 ph√∫t m·ªôt l·∫ßn, hay 10 ph√∫t m·ªôt l·∫ßn,...Tuy nhi√™n t√¥i khuy√™n b·∫°n kh√¥ng n√™n ƒë·ªÉ th·ªùi gian qu√° xa v√¨ h·ªá th·ªëng c√≥ th·ªÉ g·∫∑p v·∫•n ƒë·ªÅ m√† b·∫°n kh√¥ng th·ªÉ ph√°t hi·ªán k·ªãp th·ªùi
![image](https://github.com/user-attachments/assets/1bb569e8-766b-4431-909f-ac02c706b8c9)

b. **Check System**  
Node n√†y d√πng ƒë·ªÉ g·ª≠i c√°c Command ƒë·∫øn m√°y ch·ªß ƒë∆∞·ª£c gi√°m s√°t ƒë·ªÉ l·∫•y th√¥ng tin CPU, RAM, DISK, Inode, Load Average v√† c√°c d·ªãch v·ª• nh∆∞ Nginx MySQL, PHP-FPM    
Nh∆∞ng tr∆∞·ªõc ti√™n b·∫°n ph·∫£i th√™m Th√¥ng tin x√°c th·ª±c v√†o nh√©

![image](https://github.com/user-attachments/assets/2ef8eaa2-4526-413d-984e-8b5555e3a29e)

S·∫Ω c√≥ 2 Option ƒë·ªÉ b·∫°n x√°c th·ª±c v·ªõi m√°y ch·ªß: Password v√† Private Key
B·∫°n ƒëi·ªÅn c√°c th√¥ng tin:
- Host: L√† ƒë·ªãa ch·ªâ IP c·ªßa m√°y ch·ªß c·ªßa b·∫°n
- Port k·∫øt n·ªëi: 22 (N·∫øu b·∫°n thay ƒë·ªïi tr√™n VPS c≈©ng c·∫ßn ph·∫£i thay ƒë·ªïi ·ªü ƒë√¢y nh√©)
- Username: ƒêi·ªÅn t√™n user truy c·∫≠p c·ªßa b·∫°n
- Password: Nh·∫≠p password ƒëƒÉng nh·∫≠p c·ªßa user ·ªü tr√™n

![image](https://github.com/user-attachments/assets/bbe888e3-27bd-4f1f-866f-7cfacda2396c)

Trong tr∆∞·ªùng h·ª£p b·∫°n d√πng Private Key, b·∫°n c≈©ng nh·∫≠p th√¥ng tin nh∆∞:
- Host
- Port
- Username
- Private key: L√† Private key trong key pair m√† b·∫°n ƒë√£ t·∫°o ra
- Passphrase: B·∫°n ƒëi·ªÅn Passphrase c·ªßa key (n·∫øu c√≥)
![image](https://github.com/user-attachments/assets/0873014b-3901-41cd-8969-5cb34ab0254c)
Ti·∫øp theo t√¥i s·∫Ω gi·∫£i t√≠ch ƒëo·∫°n command ƒë∆∞·ª£c g·ª≠i ƒëi trong node n√†y
```
#!/bin/bash
CHECK_ONE=$(top -bn 1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
#echo $CHECK_ONE
sleep 70s
CHECK_TWO=$(top -bn 1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
#echo $CHECK_TWO
sleep 70s
CHECK_THREE=$(top -bn 1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
#echo $CHECK_THREE
sleep 70s
CHECK_FOUR=$(top -bn 1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
#echo $CHECK_FOUR
sleep 70s
CHECK_FIVE=$(top -bn 1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
#echo $CHECK_FIVE
if (( $(echo "$CHECK_ONE > 90" | bc -l) )) && \
   (( $(echo "$CHECK_TWO > 90" | bc -l) )) && \
   (( $(echo "$CHECK_THREE > 90" | bc -l) )) && \
   (( $(echo "$CHECK_FOUR > 90" | bc -l) )) && \
   (( $(echo "$CHECK_FIVE > 90" | bc -l) )); then

    echo $CHECK_FIVE
else
    echo 0
fi
df -ih | awk '$NF=="/"{printf "%.2f\n", $5}'
df -h | awk '$NF=="/"{printf "%.2f\n", $5}'
free | awk '/Mem:/ {printf "%.2f\n", (1 - $7/$2) * 100}'

# L·∫•y s·ªë core CPU
cores=$(nproc)
# L·∫•y load average 1 ph√∫t
load1=$(awk '{print $2}' /proc/loadavg)
# So s√°nh
threshold=$(echo "$cores * 1.0" | bc)  # cho ph√©p 100% CPU load
# In th√¥ng b√°o
if (( $(echo "$load1 > $threshold" | bc -l) )); then
    echo $load1
else
    echo 0
fi
check_nginx=$(systemctl is-active nginx | awk "{print $1}")
echo $check_nginx
check_mysql=$(systemctl is-active mysql | awk "{print $1}")
echo $check_mysql
check_php_fpm=$(systemctl is-active php8.1-fpm | awk "{print $1}")
echo $check_php_fpm
```
**Ki·ªÉmtra CPU**
```
CHECK_ONE=$(top -bn 1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
#echo $CHECK_ONE
sleep 70s
CHECK_TWO=$(top -bn 1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
#echo $CHECK_TWO
sleep 70s
CHECK_THREE=$(top -bn 1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
#echo $CHECK_THREE
sleep 70s
CHECK_FOUR=$(top -bn 1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
#echo $CHECK_FOUR
sleep 70s
CHECK_FIVE=$(top -bn 1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
#echo $CHECK_FIVE
if (( $(echo "$CHECK_ONE > 90" | bc -l) )) && \
   (( $(echo "$CHECK_TWO > 90" | bc -l) )) && \
   (( $(echo "$CHECK_THREE > 90" | bc -l) )) && \
   (( $(echo "$CHECK_FOUR > 90" | bc -l) )) && \
   (( $(echo "$CHECK_FIVE > 90" | bc -l) )); then

    echo $CHECK_FIVE
else
    echo 0
fi
```
- Ta ti·∫øn h√†nh ki·ªÉm tra CPU trong v√≤ng 5 ph√∫t v√† l∆∞u l·∫°i b·∫±ng 5 bi·∫øn **CHECK_ONE**, **CHECK_TWO**,.... sau ƒë√≥ ta so s√°nh n·∫øu c·∫£ 5 l·∫ßn CPU ƒë·ªÅu cao h∆°n 90% nghƒ©a l√† trong 5 ph√∫t v·ª´a qua CPU l√∫c n√†o c≈©ng cao h∆°n 90%  v√† in ra k·∫øt qu·∫£

**Ki·ªÉm tra Inode usage**
```
df -ih | awk '$NF=="/"{printf "%.2f\n", $5}'
```
- df -ih: xem inode usage theo ƒë·ªãnh d·∫°ng human-readable
- L·ªçc ph√¢n v√πng g·ªëc /
- In ph·∫ßn trƒÉm inode ƒëang d√πng

**Ki·ªÉm tra Disk usage**
```
df -h | awk '$NF=="/"{printf "%.2f\n", $5}'
```
Tu∆°ng t·ª± nh∆∞ ki·ªÉm tra Inode nh∆∞ng l·∫ßn n√†y s·∫Ω ki·ªÉm tra ƒëƒ©a  

**Ki·ªÉm tra RAM usage**
```
free | awk '/Mem:/ {printf "%.2f\n", (1 - $7/$2) * 100}'
```
- free: ki·ªÉm tra b·ªô nh·ªõ
- $2: t·ªïng RAM
- $7: RAM c√≤n tr·ªëng (available)
- T√≠nh RAM ƒë√£ d√πng = 100 - available/t·ªïng

**Ki·ªÉm tra Load Average**
```
cores=$(nproc)
load1=$(awk '{print $2}' /proc/loadavg)
threshold=$(echo "$cores * 1.0" | bc)
```
- nproc: l·∫•y s·ªë core CPU
- load1: l·∫•y gi√° tr·ªã load trung b√¨nh trong 1 ph√∫t
- N·∫øu load1 > s·ªë core, nghƒ©a l√† CPU ƒëang b·ªã qu√° t·∫£i  
**Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•**
```
check_nginx=$(systemctl is-active nginx)
echo $check_nginx
```
T∆∞∆°ng t·ª± nh∆∞ MySQL, PHP-FPM  
c. **Node Edit Result Check**  
Sau khi Node **Check System** th·ª±c thi th√†nh c√¥ng. Output s·∫Ω tr·∫£ v·ªÅ 1 item ki·∫øu **string** n√™n ta c·∫ßn ph·∫£i t√°ch ra v√† so s√°nh k·∫øt qu·∫£ v·ªõi ƒëi·ªÅu ki·ªán. Nh∆∞ sau:  
![image](https://github.com/user-attachments/assets/b1a2f103-5acc-41a7-8510-1d4667b7f7fe)

Node n√†y s·∫Ω chia c√°c m·∫£ng n√†y ra th√†nh m·∫£ng sau ƒë√≥ l·∫•y l·∫ßn l∆∞·ª£t k·∫øt qu·∫£ c√°c ph·∫ßn t·ª≠, d√πng h√†m trim() ƒë·ªÉ x√≥a c√°c kho·∫£ng tr·∫Øng tr∆∞·ªõc, sau v√† g√°n v√†o b·∫±ng m·ªôt t√™n nh∆∞ **CPU Status**, **Inode**, **Disk  Status** ,... *L∆∞u √Ω th·ª© t·ª± s·∫Ω ph·∫£i s·∫Øp x·∫øp ƒë√∫ng v·ªõi Node tr∆∞·ªõc nh√© n·∫øu kh√¥ng s·∫Ω x√£y ra hi·ªán t∆∞·ª£ng l·∫•y k·∫øt qu·∫£ c·ªßa CPU so s√°nh ƒëi·ªÅu ki·ªán c·ªßa RAM*  
![image](https://github.com/user-attachments/assets/18089d4c-b781-4fd6-8f32-482faccd1ecb)

d. **Node Code**  
Sau khi ƒë√£ t√°ch k·∫øt qu·∫£ ta ƒëem ƒëi so s√°nh b·∫±ng ƒëo·∫°n code sau  
![image](https://github.com/user-attachments/assets/97f982a0-425a-4f1f-a5b0-d0a82fde3625)

```
const data = $json;
// 1. C√°c service c·∫ßn check "active/inactive"
const services = [
  "Nginx Status",
  "MySQL Status",
  "PHP-FPM Status"
];

let msg = '‚ö†Ô∏è *C·∫£nh b√°o:*\n';
let alert = false;

const diskUsage = parseFloat(data["Disk Status"]);
if (!isNaN(diskUsage)) {
  if (diskUsage >= 90) { //b·∫°n c√≥ th·ªÉ thay ƒë·ªïi gi√° tr·ªã 90 n√†y theo y√™u c·∫ßu c·ªßa m√¨nh ƒë·ªÉ so s√°nh v·ªõi Disk hi·ªán t·∫°i nh√©
    alert = true;
    msg += `- üî¥ Dung l∆∞·ª£ng ƒëƒ©a ƒëang r·∫•t cao: ${diskUsage} % \n`;
  } else if (diskUsage > 80) { //b·∫°n c√≥ th·ªÉ thay ƒë·ªïi gi√° tr·ªã 80 n√†y theo y√™u c·∫ßu c·ªßa m√¨nh ƒë·ªÉ so s√°nh v·ªõi Disk hi·ªán t·∫°i nh√©
    alert = true;
    msg += `- üü° Dung l∆∞·ª£ng ƒëƒ©a ƒëang kh√° cao: ${diskUsage} % \n`;
  }
}

// T√πy ch·ªânh th√™m CPU
const cpuUsage = parseFloat(data["CPU Status"]);
if (!isNaN(cpuUsage) && cpuUsage >= 90) { // c√≥ th·ªÉ thay ƒë·ªïi th√†nh 80 n·∫øu b·∫°n mu·ªën CPU d√πng tr√™n 80% s·∫Ω c·∫£nh b√°o
  alert = true;
  msg += `- üî¥ CPU ƒëang qu√° t·∫£i: ${cpuUsage} % \n`;
}

// üëâ RAM
const ramUsage = parseFloat(data["RAM"]);
if (!isNaN(ramUsage) && ramUsage >= 90) { // c√≥ th·ªÉ thay ƒë·ªïi th√†nh 80 n·∫øu b·∫°n mu·ªën RAM d√πng tr√™n 80% s·∫Ω c·∫£nh b√°o
  alert = true;
  msg += `- üî¥ RAM ƒëang qu√° t·∫£i: ${ramUsage} % \n`;
}

// üëâ Inode
const inodeFree = parseFloat(data["Inode"]);
if (!isNaN(inodeFree) && inodeFree > 90) {  c√≥ th·ªÉ thay ƒë·ªïi th√†nh 90 n·∫øu b·∫°n mu·ªën Inode d√πng tr√™n 90% s·∫Ω c·∫£nh b√°o
  alert = true;
  msg += `- üî¥ Inode c√≤n r·∫•t th·∫•p, hi·ªán ƒëang s·ª≠ d·ª•ng: ${inodeFree} % \n`;
}

// üëâ Load Average
const loadAvg = parseFloat(data["Average"]);
if (!isNaN(loadAvg) && loadAvg > 1) { // K·∫øt qu·∫£ c·ªßa loadAvg s·∫Ω c√≥ 2 gi√° tr·ªã 0 v√† 1 n√™n b·∫°n kh√¥ng c·∫ßn ƒëi·ªÅu ch·ªânh gi√° tr·ªã n√†y
  alert = true;
  msg += `- üî¥ Load Average trong 5 ph√∫t v·ª´a qua ƒëang cao: ${loadAvg} \n`;
}

// Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•
for (const service of services) {
  const status = (data[service] || "").toLowerCase().trim();
  if (status === "inactive") {
    alert = true;
    msg += `- üî¥ ${service.trim()} ƒëang *inactive* ‚ùå\n`;
  }
}

if (!alert) {
  return []; // Kh√¥ng c√≥ c·∫£nh b√°o ‚Üí kh√¥ng g·ª≠i ti·∫øp
}

return [
  {
    json: {
      message: msg
    }
  }
];
```
e. **Node Alert Discord**  
Node n√†y s·∫Ω ƒë·∫´y th√¥ng b√°o v·ªÅ Discord, ·ªü ƒë√¢y t√¥i d√πng webhook. B·∫°n c√≥ th·ªÉ xem doc c·ªßa discord v·ªÅ webhook tr√™n discord nh√©: https://support.discord.com/hc/en-us/articles/228383668-Intro-to-Webhooks  
·ªû **Message** b·∫°n l·∫•y Output c·ªßa **Node Code** tr∆∞·ªõc ƒë√≥

![image](https://github.com/user-attachments/assets/707d0354-26d8-43c4-9e29-334f690b459b)

### K·∫øt qu·∫£

![image](https://github.com/user-attachments/assets/a61cf96f-e836-4050-b4e7-ec06b28e0e67)

























